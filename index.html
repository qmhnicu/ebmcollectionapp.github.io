<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expressed Breast Milk (EBM) Collection App</title>
    <!-- Mother holding newborn baby icon (no bottle or pacifier) -->
    <link rel="icon" href="https://thumbs.dreamstime.com/b/mother-holding-newborn-baby-heartwarming-illustration-tenderly-her-peacefully-sleeping-wrapped-blue-blanket-406661905.jpg">
    <!-- Google Translate Script -->
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,zh-CN,zh-TW,ms,ta',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <style>
        body{font-family:Arial,sans-serif;max-width:500px;margin:20px auto;padding:20px;background:#f5f7fa;color:#333}
        h1,h2{text-align:center;color:#2c3e50}
        label{display:block;margin-top:15px;font-weight:bold}
        input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;font-size:16px}
        button{background:#4CAF50;color:white;border:none;cursor:pointer;margin-top:20px}
        button:hover{background:#45a049}
        button.refresh{background:#9C27B0}
        button.delete{background:#d32f2f}
        button.export{background:#1976D2}
        button.logout{background:#607D8B}
        .section{background:white;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-top:20px}
        #stats{margin-top:20px;padding:15px;background:#e8f5e9;border-radius:8px;font-size:18px}
        #today-total{font-size:28px;font-weight:bold;text-align:center;margin:20px 0;color:#2e7d32}
        .positive{color:#2e7d32}
        .instructions{font-size:14px;color:#555;margin-top:15px;background:#fff;padding:15px;border-radius:8px}
        table{width:100%;margin-top:20px;border-collapse:collapse}
        th,td{padding:10px;border:1px solid #ddd;text-align:center}
        th{background:#e3f2fd;color:#1565c0}
        .live{font-size:12px;color:#4CAF50;text-align:center;margin:10px 0}
        .celebration{font-size:24px;text-align:center;margin:20px 0;color:#d81b60}
        #google_translate_element { text-align: center; margin: 15px 0; }
        .goog-te-gadget-simple { background-color: #f0f0f0 !important; border: 1px solid #ccc !important; padding: 8px !important; font-size: 14px !important; border-radius: 6px !important; }
        .timestamp{font-size:13px;color:#666;text-align:center;margin:10px 0}
        .aliquot-results{margin-top:30px;padding:15px;background:#e8f5e9;border-radius:8px;display:none}
        #aliquot-table th{background:#e3f2fd}
    </style>
</head>
<body>
    <!-- Google Translate Widget -->
    <div id="google_translate_element"></div>

    <h1>Expressed Breast Milk (EBM) Collection App</h1>

    <!-- Login -->
    <div id="login-section" class="section">
        <h2>Login</h2>
        <label>ID (e.g., CTM01):</label>
        <input type="text" id="user-id" placeholder="e.g., CTM01">
        <label>Password:</label>
        <input type="password" id="password">
        <button onclick="login()">Login</button>

        <div class="instructions">
            <strong>ID = Baby initials + bed number</strong><br>
            Examples: CTM01, LKM101, ABC08<br>
            <small>Case doesn't matter â€” bed23 and BED23 are the same</small><br>
            <small>New registration can only be done by healthcare staff.</small>
        </div>
    </div>

    <!-- Parent View -->
    <div id="parent-section" class="section" style="display:none">
        <h2>Welcome, <span id="current-bed"></span></h2>

        <div class="section">
            <h2>Today's Expressed Breast Milk (EBM) Provided</h2>
            <label>Volume per Bottle (ml):</label>
            <input type="number" id="volume-per-bottle" min="1" step="1" placeholder="60">
            <label>Number of Bottles:</label>
            <input type="number" id="num-bottles" min="1" step="1" placeholder="8">

            <button onclick="saveTodayProvision()">Save Today's Provision</button>
            <p style="font-size:14px;color:#666;margin-top:10px">
                You can update anytime today â€” it overwrites the previous entry.</p>
        </div>

        <button class="refresh" onclick="loadTodayData()">Refresh</button>
        <button class="logout" onclick="logout()">Logout</button>

        <div id="stats"></div>
        <div id="last-updated" class="timestamp"></div>
        <div id="today-total">Today's Total: 0 ml</div>
        <div id="celebration" class="celebration" style="display:none"></div>
    </div>

    <!-- HCW View -->
    <div id="hcw-section" class="section" style="display:none">
        <h2>Healthcare Worker Panel</h2>

        <!-- Registration in Admin Panel -->
        <div class="section">
            <h3>Register New Bed</h3>
            <label>New Bed ID (e.g., CTM01):</label>
            <input type="text" id="new-bed-id" placeholder="e.g., CTM01">
            <label>Password:</label>
            <input type="password" id="new-bed-password">
            <button onclick="registerNewBed()" style="background:#FFC107">Register Bed</button>
        </div>

        <label>Select Bed:</label>
        <select id="hcw-bed-select"></select>

        <label>Volume per Bottle (ml):</label>
        <input type="number" id="hcw-volume-per-feed" min="0" step="1">
        <label>Bottles per Day:</label>
        <input type="number" id="hcw-num-feeds" min="1" step="1">

        <button onclick="updateRequirement()">Update Target</button>
        <button class="delete" onclick="deleteBed()">Delete Selected Bed</button>
        <button class="export" onclick="exportToExcel()">Export Today's Data to Excel</button>

        <div class="live">Live â€” updates in seconds</div>

        <h3>Ward Overview â€” Today</h3>
        <table id="beds-table">
            <thead>
                <tr>
                    <th>Bed ID</th>
                    <th>Target Today</th>
                    <th>Mother's Bottles</th>
                    <th>Mother's Total</th>
                    <th>PDBM Required</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- PDBM Aliquot Tool -->
        <div class="section" style="margin-top:30px">
            <h3>PDBM Aliquot Calculator</h3>
            <button onclick="calculatePDBM()">Calculate PDBM Needs</button>
            <div id="aliquot-results" class="aliquot-results">
                <h3>Per Baby Breakdown</h3>
                <table id="aliquot-table">
                    <thead>
                        <tr>
                            <th>Bed ID</th>
                            <th>Target (ml Ã— bottles)</th>
                            <th>EBM (ml Ã— bottles)</th>
                            <th>PDBM Needed (ml)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <h3>Overall Summary</h3>
                <div id="overall-summary"></div>
            </div>
        </div>

        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB223cqRnq49791LU9P7SU9TLJmYFkegJ4",
            authDomain: "nicu-ebm-app.firebaseapp.com",
            projectId: "nicu-ebm-app",
            storageBucket: "nicu-ebm-app.firebasestorage.app",
            messagingSenderId: "191753868886",
            appId: "1:191753868886:web:972dfce99ff2c2edbd0df7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        const hcwPassword = "hcwpass";

        db.collection("users").onSnapshot(() => {
            if (currentUser === 'hcw') updateBedsTable();
        });

        function normalizeId(id) {
            return id.trim().toUpperCase();
        }

        function registerNewBed() {
            const rawId = document.getElementById('new-bed-id').value;
            const id = normalizeId(rawId);
            const pass = document.getElementById('new-bed-password').value;
            if (!rawId || !pass) return alert("Fill both fields");

            db.collection("users").doc(id).get().then(s => {
                if (s.exists) return alert("This bed ID already exists");
                db.collection("users").doc(id).set({
                    password: pass,
                    volumePerFeed: 0,
                    numFeeds: 0,
                    todayVolumePerBottle: 0,
                    todayNumBottles: 0,
                    todayMl: 0,
                    lastUpdate: "",
                    lastUpdateTimestamp: null,
                    displayId: rawId
                }).then(() => {
                    alert("New bed registered successfully!");
                    document.getElementById('new-bed-id').value = '';
                    document.getElementById('new-bed-password').value = '';
                    populateBedSelect();
                });
            });
        }

        function login() {
            const rawId = document.getElementById('user-id').value;
            const id = normalizeId(rawId);
            const pass = document.getElementById('password').value;

            if (id === 'HCW' && pass === hcwPassword) {
                currentUser = 'hcw';
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('hcw-section').style.display = 'block';
                populateBedSelect();
                updateBedsTable();
                return;
            }

            db.collection("users").doc(id).get().then(doc => {
                if (!doc.exists || doc.data().password !== pass) return alert("Wrong ID/password");
                currentUser = id;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('parent-section').style.display = 'block';
                document.getElementById('current-bed').textContent = doc.data().displayId || id;
                loadTodayData();
            });
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('parent-section').style.display = 'none';
            document.getElementById('hcw-section').style.display = 'none';
        }

        function saveTodayProvision() {
            const vol = parseInt(document.getElementById('volume-per-bottle').value);
            const num = parseInt(document.getElementById('num-bottles').value);
            if (isNaN(vol) || isNaN(num) || vol <= 0 || num <= 0) return alert("Enter valid numbers");

            const ml = vol * num;
            const today = new Date().toISOString().slice(0,10);

            db.collection("users").doc(currentUser).update({
                todayVolumePerBottle: vol,
                todayNumBottles: num,
                todayMl: ml,
                lastUpdate: today,
                lastUpdateTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('celebration').innerHTML = `
                    Well done! You have done a great job!<br>
                    Your baby thanks you so much! ðŸ’•ðŸ¥³
                `;
                document.getElementById('celebration').style.display = 'block';
                setTimeout(() => document.getElementById('celebration').style.display = 'none', 6000);
                loadTodayData();
            });
        }

        function loadTodayData() {
            db.collection("users").doc(currentUser).get().then(doc => {
                const d = doc.data();
                const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                const todayMl = d.lastUpdate === new Date().toISOString().slice(0,10) ? (d.todayMl || 0) : 0;

                document.getElementById('volume-per-bottle').value = d.todayVolumePerBottle || '';
                document.getElementById('num-bottles').value = d.todayNumBottles || '';

                document.getElementById('stats').innerHTML = `
                    <strong>Today's Target:</strong> ${d.volumePerFeed||0} ml Ã— ${d.numFeeds||0} bottles = <strong>${target} ml</strong><br>
                    <strong>Today's Provided:</strong> ${d.todayVolumePerBottle||0} ml Ã— ${d.todayNumBottles||0} bottles = <strong>${todayMl} ml</strong>
                `;

                document.getElementById('today-total').textContent = `Today's Total: ${todayMl} ml`;
                document.getElementById('today-total').className = todayMl >= target ? 'positive' : '';

                if (d.lastUpdateTimestamp) {
                    const ts = d.lastUpdateTimestamp.toDate();
                    const dateStr = ts.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
                    const timeStr = ts.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('last-updated').textContent = `Last updated on ${dateStr} at ${timeStr}`;
                } else {
                    document.getElementById('last-updated').textContent = "";
                }
            });
        }

        function updateRequirement() {
            const bed = document.getElementById('hcw-bed-select').value;
            const vol = parseInt(document.getElementById('hcw-volume-per-feed').value);
            const feeds = parseInt(document.getElementById('hcw-num-feeds').value);
            if (!bed || isNaN(vol) || isNaN(feeds)) return alert("Check all fields");

            db.collection("users").doc(bed).update({
                volumePerFeed: vol,
                numFeeds: feeds,
                lastUpdateTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Target updated!");
                document.getElementById('hcw-volume-per-feed').value = '';
                document.getElementById('hcw-num-feeds').value = '';
            });
        }

        function deleteBed() {
            const bed = document.getElementById('hcw-bed-select').value;
            if (!bed) return alert("Select a bed first");
            if (!confirm(`Delete bed ${bed} forever?`)) return;
            db.collection("users").doc(bed).delete().then(() => {
                alert("Bed deleted");
                populateBedSelect();
                updateBedsTable();
            });
        }

        function updateBedsTable() {
            const tbody = document.querySelector('#beds-table tbody');
            tbody.innerHTML = '';
            const today = new Date().toISOString().slice(0,10);

            db.collection("users").get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    const display = d.displayId || doc.id;
                    const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                    const vol = d.lastUpdate === today ? (d.todayVolumePerBottle || 0) : 0;
                    const bottles = d.lastUpdate === today ? (d.todayNumBottles || 0) : 0;
                    const total = d.lastUpdate === today ? (d.todayMl || 0) : 0;
                    const pdbm = Math.max(0, target - total);

                    let lastUpdated = "";
                    if (d.lastUpdateTimestamp) {
                        const ts = d.lastUpdateTimestamp.toDate();
                        const dateStr = ts.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
                        const timeStr = ts.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                        lastUpdated = `${dateStr} at ${timeStr}`;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${display}</strong></td>
                        <td>${d.volumePerFeed||0} ml Ã— ${d.numFeeds||0} bottles<br><small>(${target} ml)</small></td>
                        <td>${vol} ml Ã— ${bottles} bottles</td>
                        <td><strong>${total} ml</strong></td>
                        <td><strong>${pdbm} ml</strong></td>
                        <td>${lastUpdated || "-"}</td>
                    `;
                    if (pdbm === 0) row.style.background = '#e8f5e9';
                    tbody.appendChild(row);
                });
            });
        }

        function populateBedSelect() {
            const sel = document.getElementById('hcw-bed-select');
            sel.innerHTML = '<option value="">-- Select Bed --</option>';
            db.collection("users").get().then(s => {
                s.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = d.data().displayId || d.id;
                    sel.appendChild(opt);
                });
            });
        }

        function exportToExcel() {
            let csv = "Bed ID,Target (ml),Target Bottles,Mother Volume per Bottle,Mother Bottles,Mother Total,PDBM Required,Last Updated\n";
            const today = new Date().toISOString().slice(0,10);

            db.collection("users").get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    const display = d.displayId || doc.id;
                    const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                    const vol = d.lastUpdate === today ? (d.todayVolumePerBottle || 0) : 0;
                    const bottles = d.lastUpdate === today ? (d.todayNumBottles || 0) : 0;
                    const total = d.lastUpdate === today ? (d.todayMl || 0) : 0;
                    const pdbm = Math.max(0, target - total);

                    let lastUpdated = "";
                    if (d.lastUpdateTimestamp) {
                        const ts = d.lastUpdateTimestamp.toDate();
                        lastUpdated = ts.toLocaleString();
                    }

                    csv += `${display},${target},${d.numFeeds||0},${vol},${bottles},${total},${pdbm},"${lastUpdated}"\n`;
                });

                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `EBM_Ward_${today}.csv`;
                a.click();
            });
        }

        // PDBM Aliquot Calculator - Fixed variable scope
        function calculatePDBM() {
            const resultsDiv = document.getElementById('aliquot-results');
            const tableBody = document.getElementById('aliquot-table').querySelector('tbody');
            tableBody.innerHTML = '';
            let total_pdbm = 0;
            const today = new Date().toISOString().slice(0,10);  // Fixed: defined 'today' here

            db.collection("users").get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    const display = d.displayId || doc.id;
                    const targetVol = d.volumePerFeed || 0;
                    const targetBottles = d.numFeeds || 0;
                    const targetMl = targetVol * targetBottles;
                    const ebmVol = d.lastUpdate === today ? (d.todayVolumePerBottle || 0) : 0;
                    const ebmBottles = d.lastUpdate === today ? (d.todayNumBottles || 0) : 0;
                    const ebmMl = d.lastUpdate === today ? (d.todayMl || 0) : 0;
                    const pdbmMl = Math.max(0, targetMl - ebmMl);

                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${display}</td>
                        <td>${targetVol} ml Ã— ${targetBottles} bottles</td>
                        <td>${ebmVol} ml Ã— ${ebmBottles} bottles</td>
                        <td>${pdbmMl} ml</td>
                    `;

                    total_pdbm += pdbmMl;
                });

                // Bottle calculation (125ml limit, prefer larger bottles)
                let num_125 = Math.floor(total_pdbm / 125);
                let remaining = total_pdbm % 125;
                let num_50 = Math.ceil(remaining / 50);
                let waste = (num_125 * 125 + num_50 * 50) - total_pdbm;

                document.getElementById('overall-summary').innerHTML = `
                    <strong>Total PDBM Required:</strong> ${total_pdbm} ml<br>
                    <strong>125ml Bottles Needed:</strong> ${num_125}<br>
                    <strong>50ml Bottles Needed:</strong> ${num_50}<br>
                    <strong>Estimated Waste:</strong> ${waste} ml<br>
                    <small>Note: Bottles not mixed. Waste minimized.</small>
                `;

                resultsDiv.style.display = 'block';
            });
        }
    </script>
</body>
</html>
