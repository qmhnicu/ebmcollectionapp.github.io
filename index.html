<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expressed Breast Milk (EBM) Collection App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Mother holding newborn baby icon (no bottle or pacifier) -->
    <link rel="icon" href="https://thumbs.dreamstime.com/b/mother-holding-newborn-baby-heartwarming-illustration-tenderly-her-peacefully-sleeping-wrapped-blue-blanket-406661905.jpg">
    <!-- Google Translate Script -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,zh-CN,zh-TW,ms,ta,ja,de,id,vi',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <style>
        :root{
            --bg:#FEEAE6;
            --card:#FFFFFF;
            --border:#F3D8D4;
            --primary:#FEDBD0;
            --text:#442C2E;
            --muted:#6B4F4B;
            --danger:#C62828;
            --info:#5C6BC0;
            --accent:#8D6E63;
            --shadow:0 4px 12px rgba(68,44,46,0.08);
        }
        body{font-family:'Poppins',sans-serif;max-width:560px;margin:24px auto;padding:20px;background:var(--bg);color:var(--text)}
        h1,h2,h3{text-align:center;color:var(--text);margin:10px 0}
        h1{font-size:24px;font-weight:700}
        h2{font-size:20px;font-weight:600}
        h3{font-size:18px;font-weight:600}
        label{display:block;margin-top:12px;font-weight:600;color:var(--text)}
        input,select,textarea,button{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid var(--border);box-sizing:border-box;font-size:15px;font-family:inherit}
        input,select,textarea{background:#fff;color:var(--text)}
        button{background:var(--primary);color:var(--text);border:none;cursor:pointer;margin-top:16px;font-weight:600;box-shadow:var(--shadow);transition:transform .05s ease, box-shadow .2s ease}
        button:hover{box-shadow:0 6px 16px rgba(68,44,46,0.12)}
        button:active{transform:translateY(1px)}
        button.refresh{background:#E1BEE7;color:var(--text)}
        button.delete{background:#F4C7C3;color:var(--danger)}
        button.export{background:#D7E3FC;color:var(--info)}
        button.logout{background:#E7E0EC;color:var(--accent)}
        button.edit{background:#FFE9B3;margin-left:10px;font-size:13px;padding:6px 10px;border-radius:8px;box-shadow:none}
        .section{background:var(--card);padding:18px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow);margin-top:18px}
        #stats{margin-top:16px;padding:14px;background:#FFF7F5;border-radius:12px;font-size:16px;border:1px solid var(--border)}
        #today-total{font-size:24px;font-weight:700;text-align:center;margin:18px 0;color:var(--text)}
        .positive{color:#2E7D32}
        .instructions{font-size:13px;color:var(--muted);margin-top:12px;background:#FFF7F5;padding:14px;border-radius:10px;border:1px solid var(--border)}
        table{width:100%;margin-top:18px;border-collapse:collapse}
        th,td{padding:10px;border:1px solid var(--border);text-align:center}
        th{background:#FFF0ED;color:var(--text);font-weight:600}
        .live{font-size:12px;color:var(--accent);text-align:center;margin:8px 0}
        .celebration{font-size:16px;text-align:left;margin:18px 0;color:var(--text);font-weight:600;padding:14px;background:#FFF7F5;border-radius:12px;border:1px solid var(--border)}
        #google_translate_element { text-align: center; margin: 12px 0; }
        .goog-te-gadget-simple { background-color: #FFF7F5 !important; border: 1px solid var(--border) !important; padding: 8px !important; font-size: 13px !important; border-radius: 8px !important; }
        .timestamp{font-size:12px;color:var(--muted);text-align:center;margin:8px 0}
        .edit-form{margin-top:10px;padding:12px;background:#FFF7F5;border-radius:10px;border:1px solid var(--border);display:none}
        .total-row{background:#FFF0ED !important;font-weight:bold}
        .fasting-message{font-size:16px;color:#8D3B3B;text-align:center;margin:18px 0;font-weight:600}
        .reminder-box{margin-top:12px;padding:12px;background:#FFF7F5;border-radius:12px;font-size:14px;border:1px solid var(--border);text-align:left}
        .reminder-box ul, #celebration ul{margin:0;padding-left:20px;list-style-position:outside}
        .reminder-box ul ul, #celebration ul ul{margin-top:6px;padding-left:18px}
        .reminder-box li, #celebration li{margin-bottom:6px;line-height:1.4}
        .star-list{list-style:none;padding-left:0;margin:6px 0 0 0}
        .star-list li{position:relative;padding-left:18px}
        .star-list li::before{content:"☆";position:absolute;left:0;color:var(--accent)}
        .update-banner{display:none;position:sticky;top:0;z-index:5;margin:10px 0;padding:10px 12px;background:#FFF0ED;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow)}
        .update-banner p{margin:0;font-size:13px;color:var(--text)}
    </style>
</head>
<body>
    <!-- Google Translate Widget -->
    <div id="google_translate_element"></div>

    <div id="update-banner" class="update-banner">
        <p>Updating to the latest version...</p>
    </div>

    <h1>Expressed Breast Milk (EBM) Collection App</h1>

    <!-- Login -->
    <div id="login-section" class="section">
        <h2>Login</h2>
        <label>ID (e.g., CTM01):</label>
        <input type="text" id="user-id" placeholder="e.g., CTM01">
        <label>Password:</label>
        <input type="password" id="password">
        <button onclick="login()">Login</button>

        <div class="instructions">
            <strong>ID = Baby initials + bed number</strong><br>
            Examples: CTM01, LKM101, ABC08<br>
            <small>Case doesn't matter — bed23 and BED23 are the same</small><br>
            <small>New registration can only be done by healthcare staff.</small><br>
            <small>This application is solely for communication purpose. Should you have any concerns regarding condition updates of baby or lactation support, please find our team doctors and nurses during visiting hours.</small>
        </div>
    </div>

    <!-- Parent View -->
    <div id="parent-section" class="section" style="display:none">
        <h2>Welcome, <span id="current-bed"></span></h2>

        <div id="baby-info" class="section" style="margin-bottom:20px">
            <h3>Baby Information</h3>
            <div id="dol-display"></div>
            <div id="weight-display"></div>
            <div id="dolly-reminder" class="reminder-box"></div>
        </div>

        <div class="section">
            <h2>Today's Expressed Breast Milk (EBM) Provided</h2>
            <div id="fasting-message" class="fasting-message" style="display:none"></div>
            <div id="provision-form">
                <label>Volume per Bottle (ml):</label>
                <input type="number" id="volume-per-bottle" min="1" step="1" placeholder="60">
                <label>Number of Bottles:</label>
                <input type="number" id="num-bottles" min="1" step="1" placeholder="8">

                <button onclick="saveTodayProvision()">Save Today's Provision</button>
                <p style="font-size:14px;color:#666;margin-top:10px">
                    You can update anytime today — it overwrites the previous entry.</p>
            </div>
        </div>

        <button class="refresh" onclick="loadTodayData()">Refresh</button>
        <button class="logout" onclick="logout()">Logout</button>

        <div id="stats"></div>
        <div id="last-updated" class="timestamp"></div>
        <div id="today-total">Today's Total: 0 ml</div>
        <div id="celebration" class="celebration" style="display:none"></div>

    </div>

    <!-- HCW View -->
    <div id="hcw-section" class="section" style="display:none">
        <h2>Healthcare Worker Panel</h2>

        <!-- Registration in Admin Panel -->
        <div class="section">
            <h3>Register New Bed</h3>
            <label>New Bed ID (e.g., CTM01):</label>
            <input type="text" id="new-bed-id" placeholder="e.g., CTM01">
            <label>Password:</label>
            <input type="password" id="new-bed-password">
            <label>Date of Birth:</label>
            <input type="date" id="new-dob">
            <label>Current Weight (kg):</label>
            <input type="number" id="new-weight" min="0" step="0.001" placeholder="0.875">
            <button onclick="registerNewBed()" style="background:#FFC107">Register Bed</button>
        </div>

        <label>Select Bed:</label>
        <select id="hcw-bed-select"></select>

        <!-- Edit Form -->
        <div id="edit-form" class="edit-form">
            <h3>Edit Bed <span id="edit-bed-id"></span></h3>
            <label>Date of Birth:</label>
            <input type="date" id="edit-dob">
            <label>Current Weight (kg):</label>
            <input type="number" id="edit-weight" min="0" step="0.001">
            <label>Volume per Bottle (ml):</label>
            <input type="number" id="edit-volume-per-feed" min="0" step="1">
            <label>Bottles per Day:</label>
            <input type="number" id="edit-num-feeds" min="1" step="1">
            <button onclick="saveEdit()">Save Changes</button>
            <button onclick="cancelEdit()" style="background:#757575">Cancel</button>
        </div>

        <button class="delete" onclick="deleteBed()">Delete Selected Bed</button>
        <button class="export" onclick="exportToExcel()">Export Today's Data to Excel</button>

        <div class="live">Live — updates in seconds</div>

        <h3>Ward Overview — Today</h3>
        <table id="beds-table">
            <thead>
                <tr>
                    <th>Bed ID</th>
                    <th>Target Today</th>
                    <th>Mother's Bottles</th>
                    <th>Mother's Total</th>
                    <th>PDBM Required</th>
                    <th>Last Updated</th>
                    <th>Day of Life</th>
                    <th>Weight (kg)</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB223cqRnq49791LU9P7SU9TLJmYFkegJ4",
            authDomain: "nicu-ebm-app.firebaseapp.com",
            projectId: "nicu-ebm-app",
            storageBucket: "nicu-ebm-app.firebasestorage.app",
            messagingSenderId: "191753868886",
            appId: "1:191753868886:web:972dfce99ff2c2edbd0df7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        let idleTimerId = null;
        const IDLE_TIMEOUT_MS = 15 * 60 * 1000;
        const VERSION_STORAGE_KEY = "ebm_app_version_tag";
        const hcwPassword = "hcwpass";

        // Minimal breast milk reference (ml/day by DOL range)
        const minimalMilkByDOL = {
            0: 0,   // DOL 0–3
            4: 50,  // DOL 4–7
            8: 300, // DOL 8–10
            11: 400, // DOL 11–14
            15: 500 // DOL 15+
        };

        // Tailored reminders/info by DOL range
        const dolReminders = {
            "0-3": `
                <ul>
                    <li>You have already done a good job! Keep it up!</li>
                    <li><strong>Tips to increase milk supply:</strong>
                        <ul>
                            <li>Start as early as possible: express milk within 2 hours of delivery so you can feed your baby with colostrum and prevents delayed "milk come-in"</li>
                            <li>Frequent expression, at least 8 times per 24 hours: removing milk from the breasts frequently will increase milk production</li>
                            <li>At least express once at night: more milk-producing hormone is secreted at night time</li>
                            <li>Focus on skin-to-skin contact with your baby if available (Please ask nurses for assistance): helps milk flow and reduces breastfeeding difficulties</li>
                            <li>Warm compression on breast (less than 3 minutes) / gentle breast massage / relax yourself by listening to music, taking a warm shower, thinking of your baby, looking at baby's photos or videos can help milk flows faster</li>
                            <li>If you find your hand expression skills ineffective or need any assistance, please ask nurses</li>
                        </ul>
                    </li>
                </ul>
            `,
            "4-7": `
                <ul>
                    <li>You may start to feel the "milk comes in", which means breasts are getting fuller on day 3 to 4. Please keep on expressing at least 8 times per day.</li>
                    <li>For mothers who have undergone C-section, there may be a delayed milk production progress. Please keep your expression and massage going.</li>
                    <li>The volume is estimated at around 50 to 350 ml/day, varies among different mothers.</li>
                </ul>
            `,
            "8+": `
                <ul>
                    <li>Great job building your supply! Keep consistent expression (aim for 8–10 times per day).</li>
                </ul>
            `
        };

        const MS_PER_DAY = 24 * 60 * 60 * 1000;
        const minimalMilkDOLs = Object.keys(minimalMilkByDOL)
            .map(Number)
            .filter(Number.isFinite)
            .sort((a, b) => a - b);

        function getDayOfLife(dobTimestamp) {
            if (!dobTimestamp) return null;
            const dobDate = dobTimestamp.toDate ? dobTimestamp.toDate() : dobTimestamp;
            if (!dobDate || Number.isNaN(dobDate.getTime())) return null;

            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dobStart = new Date(dobDate.getFullYear(), dobDate.getMonth(), dobDate.getDate());
            const diffDays = Math.floor((todayStart - dobStart) / MS_PER_DAY);

            return diffDays < 0 ? 0 : diffDays;
        }

        function getMinimalMilkByDOL(dol) {
            if (dol === null || dol === undefined || Number.isNaN(dol)) return null;
            if (Object.prototype.hasOwnProperty.call(minimalMilkByDOL, dol)) {
                return minimalMilkByDOL[dol];
            }
            if (minimalMilkDOLs.length === 0) return null;

            const maxDOL = minimalMilkDOLs[minimalMilkDOLs.length - 1];
            if (dol > maxDOL) return minimalMilkByDOL[maxDOL];

            for (let i = minimalMilkDOLs.length - 1; i >= 0; i--) {
                if (dol >= minimalMilkDOLs[i]) return minimalMilkByDOL[minimalMilkDOLs[i]];
            }

            return minimalMilkByDOL[minimalMilkDOLs[0]];
        }

        function getReminderForDOL(dol) {
            if (dol === null || Number.isNaN(dol)) {
                return "<ul><li>Please ask the healthcare team to add the baby's date of birth so we can show day-based guidance.</li></ul>";
            }
            if (dol <= 3) return dolReminders["0-3"];
            if (dol <= 7) return dolReminders["4-7"];
            return dolReminders["8+"];
        }

        function resetIdleTimer() {
            if (idleTimerId) {
                clearTimeout(idleTimerId);
            }
            if (!currentUser) return;
            idleTimerId = setTimeout(() => {
                alert("You have been logged out due to inactivity.");
                logout();
            }, IDLE_TIMEOUT_MS);
        }

        function startIdleTracking() {
            resetIdleTimer();
        }

        function applyAppUpdate() {
            const url = new URL(window.location.href);
            url.searchParams.set("v", Date.now().toString());
            window.location.replace(url.toString());
        }

        function getVersionCheckUrl() {
            const path = window.location.pathname;
            const basePath = path.endsWith("/") ? `${path}index.html` : path;
            return `${window.location.origin}${basePath}`;
        }

        function extractVersionTag(response) {
            return response.headers.get("etag") || response.headers.get("last-modified") || "";
        }

        function handleVersionTag(tag) {
            if (!tag) return;
            const stored = localStorage.getItem(VERSION_STORAGE_KEY);
            if (stored && stored !== tag) {
                localStorage.setItem(VERSION_STORAGE_KEY, tag);
                const banner = document.getElementById("update-banner");
                if (banner) banner.style.display = "block";
                setTimeout(applyAppUpdate, 1200);
            } else if (!stored) {
                localStorage.setItem(VERSION_STORAGE_KEY, tag);
            }
        }

        function checkForUpdates() {
            const url = getVersionCheckUrl();
            fetch(url, { method: "HEAD", cache: "no-store" })
                .then(response => {
                    if (!response.ok) throw new Error("version check failed");
                    handleVersionTag(extractVersionTag(response));
                })
                .catch(() => {
                    fetch(url, { cache: "no-store" })
                        .then(response => {
                            if (!response.ok) return;
                            handleVersionTag(extractVersionTag(response));
                        })
                        .catch(() => {});
                });
        }

        db.collection("users").onSnapshot(() => {
            if (currentUser === 'hcw') updateBedsTable();
        });

        function normalizeId(id) {
            return id.trim().toUpperCase();
        }

        function registerNewBed() {
            const rawId = document.getElementById('new-bed-id').value;
            const id = normalizeId(rawId);
            const pass = document.getElementById('new-bed-password').value;
            const dob = document.getElementById('new-dob').value;
            const weight = parseFloat(document.getElementById('new-weight').value);

            if (!rawId || !pass) return alert("Fill Bed ID and password");

            db.collection("users").doc(id).get().then(s => {
                if (s.exists) return alert("This bed ID already exists");
                db.collection("users").doc(id).set({
                    password: pass,
                    volumePerFeed: 0,
                    numFeeds: 0,
                    todayVolumePerBottle: 0,
                    todayNumBottles: 0,
                    todayMl: 0,
                    lastUpdate: "",
                    lastUpdateTimestamp: null,
                    displayId: rawId,
                    dob: dob ? firebase.firestore.Timestamp.fromDate(new Date(dob)) : null,
                    weight_kg: weight || null
                }).then(() => {
                    alert("New bed registered successfully!");
                    document.getElementById('new-bed-id').value = '';
                    document.getElementById('new-bed-password').value = '';
                    document.getElementById('new-dob').value = '';
                    document.getElementById('new-weight').value = '';
                    populateBedSelect();
                });
            });
        }

        function login() {
            const rawId = document.getElementById('user-id').value;
            const id = normalizeId(rawId);
            const pass = document.getElementById('password').value;

            if (id === 'HCW' && pass === hcwPassword) {
                currentUser = 'hcw';
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('hcw-section').style.display = 'block';
                populateBedSelect();
                updateBedsTable();
                startIdleTracking();
                return;
            }

            db.collection("users").doc(id).get().then(doc => {
                if (!doc.exists || doc.data().password !== pass) return alert("Wrong ID/password");
                currentUser = id;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('parent-section').style.display = 'block';
                document.getElementById('current-bed').textContent = doc.data().displayId || id;
                loadTodayData();
                startIdleTracking();
            });
        }

        function logout() {
            currentUser = null;
            if (idleTimerId) {
                clearTimeout(idleTimerId);
                idleTimerId = null;
            }
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('parent-section').style.display = 'none';
            document.getElementById('hcw-section').style.display = 'none';
        }

        function saveTodayProvision() {
            const vol = parseInt(document.getElementById('volume-per-bottle').value);
            const num = parseInt(document.getElementById('num-bottles').value);
            if (isNaN(vol) || isNaN(num) || vol <= 0 || num <= 0) return alert("Enter valid numbers");

            const ml = vol * num;
            const today = new Date().toISOString().slice(0,10);

            db.collection("users").doc(currentUser).update({
                todayVolumePerBottle: vol,
                todayNumBottles: num,
                todayMl: ml,
                lastUpdate: today,
                lastUpdateTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                loadTodayData(); // Force refresh to show updated message/reminder
            });
        }

        function loadTodayData() {
            db.collection("users").doc(currentUser).get().then(doc => {
                const d = doc.data();
                const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                const todayKey = new Date().toISOString().slice(0,10);
                const hasTodayEntry = d.lastUpdate === todayKey;
                const todayVol = hasTodayEntry ? (d.todayVolumePerBottle || 0) : 0;
                const todayBottles = hasTodayEntry ? (d.todayNumBottles || 0) : 0;
                const todayMl = hasTodayEntry ? (d.todayMl || (todayVol * todayBottles)) : 0;

                document.getElementById('volume-per-bottle').value = hasTodayEntry ? (d.todayVolumePerBottle || '') : '';
                document.getElementById('num-bottles').value = hasTodayEntry ? (d.todayNumBottles || '') : '';

                const currentDOL = getDayOfLife(d.dob);
                const minimalToday = getMinimalMilkByDOL(currentDOL);
                const referenceLine = minimalToday === null
                    ? `<strong>Reference:</strong> Add baby's DOB to assess adequacy.<br>`
                    : `<strong>Reference for Day ${currentDOL}:</strong> ${minimalToday} ml/day — <strong>${todayMl >= minimalToday ? "Adequate" : "Below reference"}</strong><br>`;

                document.getElementById('stats').innerHTML = `
                    <strong>Today's Target:</strong> ${d.volumePerFeed||0} ml × ${d.numFeeds||0} bottles = <strong>${target} ml</strong><br>
                    <strong>Today's Provided:</strong> ${todayVol} ml × ${todayBottles} bottles = <strong>${todayMl} ml</strong><br>
                    ${referenceLine}
                `;

                document.getElementById('today-total').textContent = `Today's Total: ${todayMl} ml`;
                document.getElementById('today-total').className = todayMl >= target ? 'positive' : '';

                if (d.lastUpdateTimestamp) {
                    const ts = d.lastUpdateTimestamp.toDate();
                    const dateStr = ts.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
                    const timeStr = ts.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('last-updated').textContent = `Last updated on ${dateStr} at ${timeStr}`;
                } else {
                    document.getElementById('last-updated').textContent = "";
                }

                // Baby Info (DOL + Weight)
                const dolDisplay = document.getElementById('dol-display');
                const weightDisplay = document.getElementById('weight-display');

                if (currentDOL === null) {
                    dolDisplay.innerHTML = `<strong>Day of Life:</strong> -`;
                } else {
                    dolDisplay.innerHTML = `<strong>Day of Life:</strong> ${currentDOL}`;
                }

                if (d.weight_kg) {
                    weightDisplay.innerHTML = `<strong>Current Weight:</strong> ${d.weight_kg.toFixed(3)} kg`;
                } else {
                    weightDisplay.innerHTML = `<strong>Current Weight:</strong> -`;
                }

                // Tailored DOL reminder/info
                document.getElementById('dolly-reminder').innerHTML = getReminderForDOL(currentDOL);

                // Fasting message
                if (target === 0 && d.numFeeds === 0) {
                    document.getElementById('fasting-message').innerHTML = "Baby is currently kept fasting.";
                    document.getElementById('fasting-message').style.display = 'block';
                } else {
                    document.getElementById('fasting-message').style.display = 'none';
                }

                // Minimal supply check & tailored message
                let supplyMessage = "";
                if (minimalToday === null) {
                    supplyMessage = "<ul>" +
                        "<li>We need the baby's date of birth to assess milk adequacy. Please ask the healthcare team to update it.</li>" +
                        "</ul>";
                } else if (todayMl >= minimalToday) {
                    supplyMessage = "<ul><li>You have already done a good job! Keep it up!</li></ul>";
                } else {
                    supplyMessage = "<ul>" +
                        "<li>Remember to do hand expression at least 6 to 8 times per day, and at least once at night.</li>" +
                        "<li>Combine both expression methods by using the breast pump first until the breast is soft and then hand express the remaining milk: When breastmilk has not yet \"come in,\" or is in low supply in early days, hand-expression is usually more effective. When the breasts are fuller, using a breast pump saves effort.</li>" +
                        "<li>Hand expressing or pumping milk should not cause any pain. Reach out for healthcare professionals if you are painful.</li>" +
                        "<li>Do you feel pain or engorgement in the breast?</li>" +
                        "<li>To relieve engorgement, you can" +
                        "<ul class=\"star-list\">" +
                        "<li>Apply a cold compress to your breast using an icepack and cold towel</li>" +
                        "<li>Take painkillers, such as paracetamol</li>" +
                        "<li>Keep on expressing frequently</li>" +
                        "</ul>" +
                        "</li>" +
                        "<li>If your breast engorgement exceeds 24 hours or milk does not \"come in\" on the 4th day after delivery, please seek help from lactation consultant or the breastfeeding hotline (2255 7381).</li>" +
                        "<li>Please find our ward nurses if you need any lactation support!</li>" +
                        "</ul>";
                }

                document.getElementById('celebration').innerHTML = supplyMessage;
                document.getElementById('celebration').style.display = 'block';
            });
        }

        function updateRequirement() {
            const bed = document.getElementById('hcw-bed-select').value;
            const vol = parseInt(document.getElementById('hcw-volume-per-feed').value);
            const feeds = parseInt(document.getElementById('hcw-num-feeds').value);
            if (!bed || isNaN(vol) || isNaN(feeds)) return alert("Check all fields");

            db.collection("users").doc(bed).update({
                volumePerFeed: vol,
                numFeeds: feeds,
                lastUpdateTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Target updated!");
                document.getElementById('hcw-volume-per-feed').value = '';
                document.getElementById('hcw-num-feeds').value = '';
            });
        }

        function deleteBed() {
            const bed = document.getElementById('hcw-bed-select').value;
            if (!bed) return alert("Select a bed first");
            if (!confirm(`Delete bed ${bed} forever?`)) return;
            db.collection("users").doc(bed).delete().then(() => {
                alert("Bed deleted");
                populateBedSelect();
                updateBedsTable();
            });
        }

        function editBed(bedId) {
            db.collection("users").doc(bedId).get().then(doc => {
                const d = doc.data();
                document.getElementById('edit-bed-id').textContent = d.displayId || bedId;
                document.getElementById('edit-dob').value = d.dob ? d.dob.toDate().toISOString().split('T')[0] : '';
                document.getElementById('edit-weight').value = d.weight_kg || '';
                document.getElementById('edit-volume-per-feed').value = d.volumePerFeed || '';
                document.getElementById('edit-num-feeds').value = d.numFeeds || '';
                document.getElementById('edit-form').style.display = 'block';
                document.getElementById('edit-form').dataset.bedId = bedId;

                document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        function saveEdit() {
            const bedId = document.getElementById('edit-form').dataset.bedId;
            const dob = document.getElementById('edit-dob').value;
            const weight = parseFloat(document.getElementById('edit-weight').value);
            const vol = parseInt(document.getElementById('edit-volume-per-feed').value);
            const feeds = parseInt(document.getElementById('edit-num-feeds').value);

            db.collection("users").doc(bedId).update({
                dob: dob ? firebase.firestore.Timestamp.fromDate(new Date(dob)) : null,
                weight_kg: weight || null,
                volumePerFeed: vol || 0,
                numFeeds: feeds || 0,
                lastUpdateTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Bed updated successfully!");
                cancelEdit();
                updateBedsTable();
            });
        }

        function cancelEdit() {
            document.getElementById('edit-form').style.display = 'none';
        }

        function updateBedsTable() {
            const tbody = document.querySelector('#beds-table tbody');
            tbody.innerHTML = '';
            const today = new Date().toISOString().slice(0,10);
            let cumulative_pdbm = 0;

            db.collection("users").get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    const display = d.displayId || doc.id;
                    const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                    const vol = d.lastUpdate === today ? (d.todayVolumePerBottle || 0) : 0;
                    const bottles = d.lastUpdate === today ? (d.todayNumBottles || 0) : 0;
                    const total = d.lastUpdate === today ? (d.todayMl || 0) : 0;
                    const pdbm = Math.max(0, target - total);
                    cumulative_pdbm += pdbm;

                    let lastUpdated = "";
                    if (d.lastUpdateTimestamp) {
                        const ts = d.lastUpdateTimestamp.toDate();
                        const dateStr = ts.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
                        const timeStr = ts.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                        lastUpdated = `${dateStr} at ${timeStr}`;
                    }

                    let dol = "-";
                    if (d.dob) {
                        const dobDate = d.dob.toDate();
                        const todayDate = new Date();
                        dol = Math.floor((todayDate - dobDate) / (1000 * 60 * 60 * 24));
                    }

                    let weightDisplay = d.weight_kg ? d.weight_kg.toFixed(3) + " kg" : "-";

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${display}</strong></td>
                        <td>${d.volumePerFeed||0} ml × ${d.numFeeds||0} bottles<br><small>(${target} ml)</small></td>
                        <td>${vol} ml × ${bottles} bottles</td>
                        <td><strong>${total} ml</strong></td>
                        <td><strong>${pdbm} ml</strong></td>
                        <td>${lastUpdated || "-"}</td>
                        <td>Day ${dol}</td>
                        <td>${weightDisplay}</td>
                        <td><button class="edit" onclick="editBed('${doc.id}')">✏️</button></td>
                    `;
                    if (pdbm === 0) row.style.background = '#e8f5e9';
                    tbody.appendChild(row);
                });

                const cumRow = document.createElement('tr');
                cumRow.className = 'total-row';
                cumRow.innerHTML = `
                    <td colspan="5"><strong>Total PDBM Required</strong></td>
                    <td colspan="4"><strong>${cumulative_pdbm} ml</strong></td>
                `;
                tbody.appendChild(cumRow);
            });
        }

        function populateBedSelect() {
            const sel = document.getElementById('hcw-bed-select');
            sel.innerHTML = '<option value="">-- Select Bed --</option>';
            db.collection("users").get().then(s => {
                s.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = d.data().displayId || d.id;
                    sel.appendChild(opt);
                });
            });
        }

        function exportToExcel() {
            let csv = "Bed ID,Target (ml),Target Bottles,Mother Volume per Bottle,Mother Bottles,Mother Total,PDBM Required,Last Updated\n";
            const today = new Date().toISOString().slice(0,10);

            db.collection("users").get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    const display = d.displayId || doc.id;
                    const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                    const vol = d.lastUpdate === today ? (d.todayVolumePerBottle || 0) : 0;
                    const bottles = d.lastUpdate === today ? (d.todayNumBottles || 0) : 0;
                    const total = d.lastUpdate === today ? (d.todayMl || 0) : 0;
                    const pdbm = Math.max(0, target - total);

                    let lastUpdated = "";
                    if (d.lastUpdateTimestamp) {
                        const ts = d.lastUpdateTimestamp.toDate();
                        lastUpdated = ts.toLocaleString();
                    }

                    csv += `${display},${target},${d.numFeeds||0},${vol},${bottles},${total},${pdbm},"${lastUpdated}"\n`;
                });

                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `EBM_Ward_${today}.csv`;
                a.click();
            });
        }

        ["click", "keydown", "mousemove", "scroll", "touchstart"].forEach(evt => {
            document.addEventListener(evt, () => {
                if (currentUser) resetIdleTimer();
            }, { passive: true });
        });

        window.addEventListener("load", () => {
            checkForUpdates();
            setInterval(checkForUpdates, 5 * 60 * 1000);
        });

    </script>
</body>
</html>
