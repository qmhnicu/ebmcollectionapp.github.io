<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBM Collection App</title>
    <link rel="icon" href="https://img.freepik.com/premium-vector/kawaii-cute-feeding-bottle-cartoon-vector-illustration_1120558-48308.jpg">
    <style>
        body{font-family:Arial,sans-serif;max-width:500px;margin:20px auto;padding:20px;background:#f5f7fa;color:#333}
        h1,h2{text-align:center;color:#2c3e50}
        label{display:block;margin-top:15px;font-weight:bold}
        input,button{width:100%;padding:12px;margin-top:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;font-size:16px}
        button{background:#4CAF50;color:white;border:none;cursor:pointer;margin-top:20px}
        button:hover{background:#45a049}
        button.refresh{background:#9C27B0}
        button.logout{background:#607D8B}
        .section{background:white;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-top:20px}
        #stats{margin-top:20px;padding:15px;background:#e8f5e9;border-radius:8px;font-size:18px}
        #today-total{font-size:28px;font-weight:bold;text-align:center;margin:20px 0;color:#2e7d32}
        .positive{color:#2e7d32}
        .instructions{font-size:14px;color:#555;margin-top:15px;background:#fff;padding:15px;border-radius:8px}
        table{width:100%;margin-top:20px;border-collapse:collapse}
        th,td{padding:10px;border:1px solid #ddd;text-align:center}
        th{background:#f0f0f0}
        .live{font-size:12px;color:#4CAF50;text-align:center;margin:10px 0}
    </style>
</head>
<body>
    <h1>EBM Collection App</h1>

    <!-- Login -->
    <div id="login-section" class="section">
        <h2>Login</h2>
        <label>ID (e.g., CTM01):</label>
        <input type="text" id="user-id" placeholder="e.g., 123">
        <label>Password:</label>
        <input type="password" id="password">
        <button onclick="login()">Login</button>
        <button onclick="registerParent()" style="background:#FFC107;margin-top:10px;">Register New Bed</button>

        <div class="instructions">
            <strong>ID = Baby initials + bed number</strong><br>
            Examples: CTM01, LKM101, ABC08
        </div>
    </div>

    <!-- Parent View -->
    <div id="parent-section" class="section" style="display:none">
        <h2>Welcome, <span id="current-bed"></span></h2>

        <div class="section">
            <h2>Today's EBM Provided</h2>
            <label>Total volume prepared today (ml):</label>
            <input type="number" id="today-ml" min="0" step="1" placeholder="e.g., 480">

            <button onclick="saveTodayTotal()">Save Today's Total</button>
            <p style="font-size:14px;color:#666;margin-top:10px">
                You can change and re-save this number anytime today.<br>
                It will overwrite the previous entry.
            </p>
        </div>

        <button class="refresh" onclick="loadTodayData()">Refresh</button>
        <button class="logout" onclick="logout()">Logout</button>

        <div id="stats"></div>
        <div id="today-total">Today's Total: 0 ml</div>
    </div>

    <!-- HCW View -->
    <div id="hcw-section" class="section" style="display:none">
        <h2>Healthcare Worker Panel</h2>

        <label>Select Bed:</label>
        <select id="hcw-bed-select"></select>

        <label>Volume per Feed (ml):</label>
        <input type="number" id="hcw-volume-per-feed" min="0" step="1">
        <label>Feeds per Day:</label>
        <input type="number" id="hcw-num-feeds" min="1" step="1">

        <button onclick="updateRequirement()">Update Target</button>

        <div class="live">Live — updates in seconds</div>

        <h3>Ward Overview — Today Only</h3>
        <table id="beds-table">
            <thead><tr><th>Bed ID</th><th>Target Today</th><th>Provided Today</th><th>Status</th></tr></thead>
            <tbody></tbody>
        </table>

        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <script>
       // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyB223cqRnq49791LU9P7SU9TLJmYFkegJ4",
  authDomain: "nicu-ebm-app.firebaseapp.com",
  projectId: "nicu-ebm-app",
  storageBucket: "nicu-ebm-app.firebasestorage.app",
  messagingSenderId: "191753868886",
  appId: "1:191753868886:web:972dfce99ff2c2edbd0df7"
}

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        const hcwPassword = "hcwpass";

        // Real-time update for HCW table
        db.collection("users").onSnapshot(() => {
            if (currentUser === 'hcw') updateBedsTable();
        });

        function registerParent() {
            const id = document.getElementById('user-id').value.trim().toUpperCase();
            const pass = document.getElementById('password').value;
            if (!id || !pass) return alert("Fill both");
            db.collection("users").doc(id).get().then(s => {
                if (s.exists) return alert("Already exists");
                db.collection("users").doc(id).set({
                    password: pass,
                    volumePerFeed: 0,
                    numFeeds: 0,
                    todayMl: 0,
                    lastUpdate: ""
                }).then(() => alert("Registered!"));
            });
        }

        function login() {
            let id = document.getElementById('user-id').value.trim().toUpperCase();
            const pass = document.getElementById('password').value;

            if (id === 'HCW' && pass === hcwPassword) {
                currentUser = 'hcw';
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('hcw-section').style.display = 'block';
                populateBedSelect();
                updateBedsTable();
                return;
            }

            db.collection("users").doc(id).get().then(doc => {
                if (!doc.exists || doc.data().password !== pass) return alert("Wrong ID/password");
                currentUser = id;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('parent-section').style.display = 'block';
                document.getElementById('current-bed').textContent = id;
                loadTodayData();
            });
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('parent-section').style.display = 'none';
            document.getElementById('hcw-section').style.display = 'none';
        }

        // Parent: Save today's total (overwrites)
        function saveTodayTotal() {
            const ml = parseInt(document.getElementById('today-ml').value);
            if (isNaN(ml) || ml < 0) return alert("Enter valid number");

            const today = new Date().toISOString().slice(0,10);

            db.collection("users").doc(currentUser).update({
                todayMl: ml,
                lastUpdate: today
            }).then(() => {
                alert(`Saved! Today's total = ${ml} ml`);
                loadTodayData();
            });
        }

        function loadTodayData() {
            db.collection("users").doc(currentUser).get().then(doc => {
                const d = doc.data();
                const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                const todayMl = d.todayMl || 0;

                document.getElementById('today-ml').value = todayMl;

                document.getElementById('stats').innerHTML = `
                    <strong>Today's Target:</strong> ${d.volumePerFeed||0} ml × ${d.numFeeds||0} feeds = <strong>${target} ml</strong><br>
                    <strong>Today's Provided:</strong> ${todayMl} ml
                `;

                document.getElementById('today-total').textContent = `Today's Total: ${todayMl} ml`;
                document.getElementById('today-total').className = todayMl >= target ? 'positive' : '';
            });
        }

        // HCW: Update target
        function updateRequirement() {
            const bed = document.getElementById('hcw-bed-select').value;
            const vol = parseInt(document.getElementById('hcw-volume-per-feed').value);
            const feeds = parseInt(document.getElementById('hcw-num-feeds').value);
            if (!bed || isNaN(vol) || isNaN(feeds)) return alert("Check fields");
            db.collection("users").doc(bed).set({ volumePerFeed: vol, numFeeds: feeds }, { merge: true })
                .then(() => alert("Target updated!"));
        }

        // HCW: Table — shows only TODAY
        function updateBedsTable() {
            const tbody = document.querySelector('#beds-table tbody');
            tbody.innerHTML = '';
            const today = new Date().toISOString().slice(0,10);

            db.collection("users").get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    const target = (d.volumePerFeed || 0) * (d.numFeeds || 0);
                    const provided = (d.lastUpdate === today) ? (d.todayMl || 0) : 0;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${doc.id}</strong></td>
                        <td>${target} ml</td>
                        <td>${provided} ml</td>
                        <td>${provided >= target ? 'Complete' : 'Pending'}</td>
                    `;
                    if (provided >= target) row.style.background = '#e8f5e9';
                    tbody.appendChild(row);
                });
            });
        }

        function populateBedSelect() {
            const sel = document.getElementById('hcw-bed-select');
            sel.innerHTML = '<option value="">-- Select --</option>';
            db.collection("users").get().then(s => {
                s.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d.id; opt.textContent = d.id;
                    sel.appendChild(opt);
                });
            });
        }
    </script>
</body>
</html>

